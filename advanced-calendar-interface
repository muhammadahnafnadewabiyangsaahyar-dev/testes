<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Calendar Interface - Enterprise Grade</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ============ ADVANCED CALENDAR INTERFACE STYLES ============ */
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
            color: #333;
        }
        
        .calendar-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .calendar-title {
            font-size: 24px;
            font-weight: 600;
            color: #1976d2;
        }
        
        .calendar-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-primary {
            background: #1976d2;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1565c0;
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #666;
            border: 1px solid #ddd;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .btn-success {
            background: #4caf50;
            color: white;
        }
        
        .btn-success:hover {
            background: #43a047;
        }
        
        .btn-warning {
            background: #ff9800;
            color: white;
        }
        
        .btn-warning:hover {
            background: #f57c00;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background: #e53935;
        }
        
        .calendar-grid {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .calendar-grid-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: #1976d2;
            color: white;
        }
        
        .calendar-grid-header div {
            padding: 15px;
            text-align: center;
            font-weight: 600;
        }
        
        .calendar-grid-body {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e0e0e0;
        }
        
        .calendar-day {
            background: white;
            min-height: 120px;
            padding: 8px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .calendar-day:hover {
            background: #f0f8ff;
        }
        
        .calendar-day.other-month {
            background: #fafafa;
            color: #999;
        }
        
        .calendar-day.today {
            background: #e3f2fd;
        }
        
        .day-number {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .day-shifts {
            margin-top: 5px;
        }
        
        .shift-item {
            background: #1976d2;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 2px;
            cursor: move;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .shift-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .shift-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            z-index: 1000;
        }
        
        .shift-item.morning {
            background: #ff9800;
        }
        
        .shift-item.afternoon {
            background: #2196f3;
        }
        
        .shift-item.evening {
            background: #9c27b0;
        }
        
        .shift-item.night {
            background: #607d8b;
        }
        
        /* ============ DRAG & DROP INTERFACE ============ */
        
        .drop-zone {
            min-height: 60px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            background: #fafafa;
            transition: all 0.3s ease;
            padding: 10px;
            margin: 5px 0;
        }
        
        .drop-zone.drag-over {
            border-color: #1976d2;
            background: #e3f2fd;
        }
        
        .drop-zone.dropped {
            border-color: #4caf50;
            background: #e8f5e9;
        }
        
        .template-library {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-top: 20px;
        }
        
        .template-library h3 {
            margin-top: 0;
            color: #1976d2;
        }
        
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .template-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
            cursor: move;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .template-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .template-card.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            z-index: 1000;
        }
        
        .template-card.active {
            border-color: #1976d2;
            background: #e3f2fd;
        }
        
        .template-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .template-time {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .template-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }
        
        .template-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 0 1px #ccc;
        }
        
        /* ============ SIDE PANEL ============ */
        
        .side-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 12px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .side-panel.open {
            right: 0;
        }
        
        .side-panel-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .side-panel-content {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
        }
        
        .color-picker {
            width: 100%;
            height: 40px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        
        /* ============ SEARCH & FILTER ============ */
        
        .search-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .search-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 14px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
        }
        
        .filter-dropdown {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }
        
        /* ============ MODAL ============ */
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #1976d2;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .close-btn:hover {
            color: #333;
        }
        
        /* ============ TOOLTIP ============ */
        
        .tooltip {
            position: absolute;
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 2000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .tooltip.show {
            opacity: 1;
        }
        
        /* ============ LOADING SPINNER ============ */
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ============ NOTIFICATIONS ============ */
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            font-weight: 500;
            z-index: 3000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .notification.success {
            background: #4caf50;
        }
        
        .notification.error {
            background: #f44336;
        }
        
        .notification.warning {
            background: #ff9800;
        }
        
        .notification.info {
            background: #2196f3;
        }
        
        /* ============ RESPONSIVE ============ */
        
        @media (max-width: 768px) {
            .calendar-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .calendar-controls {
                flex-wrap: wrap;
            }
            
            .search-filter {
                flex-direction: column;
                align-items: stretch;
            }
            
            .side-panel {
                width: 100%;
                right: -100%;
            }
            
            .template-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* ============ REAL-TIME INDICATORS ============ */
        
        .realtime-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            background: #4caf50;
            color: white;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .realtime-indicator::before {
            content: '';
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: #f5f5f5;
            border-top: 1px solid #e0e0e0;
            font-size: 12px;
            color: #666;
        }
        
        .status-left, .status-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="calendar-container">
        <!-- Calendar Header -->
        <div class="calendar-header">
            <div>
                <h1 class="calendar-title">
                    Advanced Calendar System
                    <span class="realtime-indicator">Live</span>
                </h1>
                <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">
                    Enterprise-grade shift management with drag & drop
                </p>
            </div>
            
            <div class="calendar-controls">
                <button class="btn btn-secondary" id="prev-month">
                    <span>‚Äπ</span> Previous
                </button>
                <button class="btn btn-primary" id="current-month">
                    <span class="month-label">November 2024</span>
                </button>
                <button class="btn btn-secondary" id="next-month">
                    Next <span>‚Ä∫</span>
                </button>
                
                <div style="margin-left: 20px; display: flex; gap: 10px;">
                    <button class="btn btn-secondary" id="view-month">Month</button>
                    <button class="btn btn-secondary" id="view-week">Week</button>
                    <button class="btn btn-secondary" id="view-day">Day</button>
                </div>
            </div>
        </div>
        
        <!-- Search and Filter Bar -->
        <div class="search-filter">
            <input type="text" class="search-input" placeholder="üîç Search shifts, employees, or templates..." id="search-input">
            <select class="filter-dropdown" id="category-filter">
                <option value="">All Categories</option>
                <option value="morning">Morning</option>
                <option value="afternoon">Afternoon</option>
                <option value="evening">Evening</option>
                <option value="night">Night</option>
                <option value="custom">Custom</option>
            </select>
            <button class="btn btn-secondary" id="advanced-filter">Filters</button>
            <button class="btn btn-primary" id="add-template">
                <span>+</span> Add Template
            </button>
        </div>
        
        <!-- Calendar Grid -->
        <div class="calendar-grid">
            <div class="calendar-grid-header">
                <div>Sunday</div>
                <div>Monday</div>
                <div>Tuesday</div>
                <div>Wednesday</div>
                <div>Thursday</div>
                <div>Friday</div>
                <div>Saturday</div>
            </div>
            <div class="calendar-grid-body" id="calendar-grid">
                <!-- Calendar days will be generated here -->
            </div>
        </div>
        
        <!-- Template Library -->
        <div class="template-library">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>Shift Templates Library</h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" id="import-templates">üì§ Import</button>
                    <button class="btn btn-secondary" id="export-templates">üì• Export</button>
                    <button class="btn btn-success" id="new-template">‚ûï New Template</button>
                </div>
            </div>
            
            <div class="template-grid" id="template-grid">
                <!-- Template cards will be loaded here -->
            </div>
        </div>
        
        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-left">
                <span id="connection-status">
                    <span style="color: #4caf50;">‚óè</span> Connected
                </span>
                <span id="last-sync">
                    Last sync: <span id="sync-time">Just now</span>
                </span>
                <span id="user-info">
                    User: <span id="current-user">Loading...</span>
                </span>
            </div>
            <div class="status-right">
                <span id="version">Calendar v3.0.0</span>
                <button class="btn btn-secondary" id="settings-btn">‚öôÔ∏è</button>
            </div>
        </div>
    </div>
    
    <!-- Side Panel for Template Editing -->
    <div class="side-panel" id="template-side-panel">
        <div class="side-panel-header">
            <h3 id="panel-title">Edit Template</h3>
            <button class="close-btn" id="close-panel">√ó</button>
        </div>
        <div class="side-panel-content" id="panel-content">
            <!-- Template form will be loaded here -->
        </div>
    </div>
    
    <!-- Modal for Template Creation/Editing -->
    <div class="modal" id="template-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Create New Template</h3>
                <button class="close-btn" id="close-modal">√ó</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Form content -->
            </div>
        </div>
    </div>
    
    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loading-spinner" style="display: none;">
        <div class="loading"></div>
    </div>
    
    <!-- JavaScript -->
    <script>
        // ============ ADVANCED CALENDAR FRONTEND ============
        
        class AdvancedCalendarApp {
            constructor() {
                this.currentDate = new Date();
                this.currentView = 'month';
                this.selectedTemplates = new Set();
                this.isConnected = false;
                this.websocket = null;
                
                this.init();
            }
            
            async init() {
                await this.loadTemplates();
                this.generateCalendar();
                this.setupEventListeners();
                this.connectWebSocket();
                this.updateUI();
            }
            
            // ============ TEMPLATE MANAGEMENT ============
            
            async loadTemplates() {
                try {
                    this.showLoading(true);
                    
                    const response = await fetch('/api/v3/shift-templates');
                    const result = await response.json();
                    
                    if (result.success) {
                        this.templates = result.data;
                        this.renderTemplates();
                    } else {
                        this.showNotification('Failed to load templates', 'error');
                    }
                } catch (error) {
                    console.error('Error loading templates:', error);
                    this.showNotification('Error loading templates', 'error');
                } finally {
                    this.showLoading(false);
                }
            }
            
            renderTemplates() {
                const grid = document.getElementById('template-grid');
                if (!grid) return;
                
                grid.innerHTML = '';
                
                this.templates.forEach(template => {
                    const card = this.createTemplateCard(template);
                    grid.appendChild(card);
                });
            }
            
            createTemplateCard(template) {
                const card = document.createElement('div');
                card.className = 'template-card';
                card.draggable = true;
                card.dataset.templateId = template.id;
                
                card.innerHTML = `
                    <div class="template-name">${template.display_name}</div>
                    <div class="template-time">
                        ${this.formatTime(template.start_time)} - ${this.formatTime(template.end_time)}
                    </div>
                    <div style="font-size: 12px; color: #666; margin: 8px 0;">
                        üìÖ ${template.category || 'General'}
                    </div>
                    <div class="template-info">
                        <span style="font-size: 12px; color: #666;">
                            Usage: ${template.usage_count || 0}
                        </span>
                        <div class="template-color" style="background-color: ${template.color_hex}"></div>
                    </div>
                `;
                
                // Setup drag events
                card.addEventListener('dragstart', (e) => this.handleDragStart(e, template));
                card.addEventListener('dragend', (e) => this.handleDragEnd(e));
                card.addEventListener('click', () => this.editTemplate(template));
                
                return card;
            }
            
            // ============ CALENDAR RENDERING ============
            
            generateCalendar() {
                const grid = document.getElementById('calendar-grid');
                if (!grid) return;
                
                grid.innerHTML = '';
                
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const firstDayOfWeek = firstDay.getDay();
                const daysInMonth = lastDay.getDate();
                
                // Calculate previous month's days
                const prevMonth = new Date(year, month - 1, 0);
                const daysInPrevMonth = prevMonth.getDate();
                
                // Generate 6 weeks of calendar
                for (let week = 0; week < 6; week++) {
                    for (let day = 0; day < 7; day++) {
                        const dayElement = document.createElement('div');
                        dayElement.className = 'calendar-day';
                        
                        let dayNumber;
                        let isCurrentMonth = true;
                        
                        if (week === 0 && day < firstDayOfWeek) {
                            // Previous month
                            dayNumber = daysInPrevMonth - firstDayOfWeek + day + 1;
                            isCurrentMonth = false;
                        } else if (week === 5 && day >= daysInMonth % 7) {
                            // Next month
                            dayNumber = day - (daysInMonth % 7) + 1;
                            isCurrentMonth = false;
                        } else {
                            // Current month
                            dayNumber = week * 7 + day - firstDayOfWeek + 1;
                        }
                        
                        if (!isCurrentMonth) {
                            dayElement.classList.add('other-month');
                        }
                        
                        // Check if it's today
                        const today = new Date();
                        if (isCurrentMonth && dayNumber === today.getDate() && 
                            month === today.getMonth() && year === today.getFullYear()) {
                            dayElement.classList.add('today');
                        }
                        
                        // Add day number
                        const dayNumberElement = document.createElement('div');
                        dayNumberElement.className = 'day-number';
                        dayNumberElement.textContent = dayNumber;
                        dayElement.appendChild(dayNumberElement);
                        
                        // Add drop zone
                        const dropZone = document.createElement('div');
                        dropZone.className = 'drop-zone';
                        dropZone.dataset.date = `${year}-${String(month + 1).padStart(2, '0')}-${String(dayNumber).padStart(2, '0')}`;
                        
                        dayElement.appendChild(dropZone);
                        
                        // Setup drop events
                        this.setupDropEvents(dropZone);
                        
                        grid.appendChild(dayElement);
                    }
                }
                
                this.updateMonthLabel();
            }
            
            setupDropEvents(dropZone) {
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('drag-over');
                });
                
                dropZone.addEventListener('dragleave', (e) => {
                    dropZone.classList.remove('drag-over');
                });
                
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('drag-over');
                    dropZone.classList.add('dropped');
                    
                    const templateId = e.dataTransfer.getData('text/template-id');
                    const templateData = JSON.parse(e.dataTransfer.getData('application/json'));
                    
                    this.handleTemplateDrop(templateData, dropZone.dataset.date);
                    
                    setTimeout(() => {
                        dropZone.classList.remove('dropped');
                    }, 1000);
                });
            }
            
            async handleTemplateDrop(template, date) {
                try {
                    this.showLoading(true);
                    
                    const assignment = {
                        shift_template_id: template.id,
                        shift_date: date,
                        employee_ids: [] // Will be selected in a modal
                    };
                    
                    // Open employee selection modal
                    await this.showEmployeeSelection(assignment);
                    
                } catch (error) {
                    console.error('Error assigning template:', error);
                    this.showNotification('Failed to assign template', 'error');
                } finally {
                    this.showLoading(false);
                }
            }
            
            // ============ DRAG & DROP ============
            
            handleDragStart(e, template) {
                e.dataTransfer.effectAllowed = 'copy';
                e.dataTransfer.setData('text/template-id', template.id);
                e.dataTransfer.setData('application/json', JSON.stringify(template));
                
                e.target.classList.add('dragging');
            }
            
            handleDragEnd(e) {
                e.target.classList.remove('dragging');
            }
            
            // ============ TEMPLATE CRUD ============
            
            editTemplate(template) {
                const panel = document.getElementById('template-side-panel');
                const panelTitle = document.getElementById('panel-title');
                const panelContent = document.getElementById('panel-content');
                
                panelTitle.textContent = 'Edit Template';
                this.renderTemplateForm(panelContent, template);
                panel.classList.add('open');
            }
            
            async createTemplate() {
                const panel = document.getElementById('template-side-panel');
                const panelTitle = document.getElementById('panel-title');
                const panelContent = document.getElementById('panel-content');
                
                panelTitle.textContent = 'Create New Template';
                this.renderTemplateForm(panelContent);
                panel.classList.add('open');
            }
            
            renderTemplateForm(container, template = null) {
                container.innerHTML = `
                    <form id="template-form">
                        <div class="form-group">
                            <label for="template-name">Template Name</label>
                            <input type="text" class="form-control" id="template-name" 
                                   value="${template?.name || ''}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="template-display-name">Display Name</label>
                            <input type="text" class="form-control" id="template-display-name" 
                                   value="${template?.display_name || ''}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="start-time">Start Time</label>
                            <input type="time" class="form-control" id="start-time" 
                                   value="${template?.start_time?.slice(0, 5) || ''}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="end-time">End Time</label>
                            <input type="time" class="form-control" id="end-time" 
                                   value="${template?.end_time?.slice(0, 5) || ''}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="color-hex">Color</label>
                            <input type="color" class="color-picker" id="color-hex" 
                                   value="${template?.color_hex || '#2196f3'}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="icon-emoji">Icon Emoji</label>
                            <input type="text" class="form-control" id="icon-emoji" 
                                   value="${template?.icon_emoji || 'üìÖ'}" maxlength="4" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="category">Category</label>
                            <select class="form-control" id="category" required>
                                <option value="morning" ${template?.category === 'morning' ? 'selected' : ''}>Morning</option>
                                <option value="afternoon" ${template?.category === 'afternoon' ? 'selected' : ''}>Afternoon</option>
                                <option value="evening" ${template?.category === 'evening' ? 'selected' : ''}>Evening</option>
                                <option value="night" ${template?.category === 'night' ? 'selected' : ''}>Night</option>
                                <option value="custom" ${template?.category === 'custom' ? 'selected' : ''}>Custom</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="description">Description</label>
                            <textarea class="form-control" id="description" rows="3">${template?.description || ''}</textarea>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="btn btn-success" style="flex: 1;">
                                ${template ? 'Update' : 'Create'} Template
                            </button>
                            ${template ? `<button type="button" class="btn btn-danger" onclick="app.deleteTemplate(${template.id})">Delete</button>` : ''}
                        </div>
                    </form>
                `;
                
                // Setup form submission
                const form = document.getElementById('template-form');
                form.addEventListener('submit', (e) => this.handleTemplateSubmit(e, template?.id));
            }
            
            async handleTemplateSubmit(e, templateId = null) {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const templateData = {
                    name: document.getElementById('template-name').value,
                    display_name: document.getElementById('template-display-name').value,
                    start_time: document.getElementById('start-time').value + ':00',
                    end_time: document.getElementById('end-time').value + ':00',
                    color_hex: document.getElementById('color-hex').value,
                    icon_emoji: document.getElementById('icon-emoji').value,
                    category: document.getElementById('category').value,
                    description: document.getElementById('description').value
                };
                
                try {
                    this.showLoading(true);
                    
                    const url = templateId ? 
                        `/api/v3/shift-templates/${templateId}` : 
                        '/api/v3/shift-templates';
                    
                    const method = templateId ? 'PUT' : 'POST';
                    
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(templateData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showNotification(`Template ${templateId ? 'updated' : 'created'} successfully`, 'success');
                        this.closeSidePanel();
                        await this.loadTemplates();
                    } else {
                        this.showNotification(result.error || 'Failed to save template', 'error');
                    }
                } catch (error) {
                    console.error('Error saving template:', error);
                    this.showNotification('Error saving template', 'error');
                } finally {
                    this.showLoading(false);
                }
            }
            
            async deleteTemplate(templateId) {
                if (!confirm('Are you sure you want to delete this template?')) {
                    return;
                }
                
                try {
                    this.showLoading(true);
                    
                    const response = await fetch(`/api/v3/shift-templates/${templateId}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.showNotification('Template deleted successfully', 'success');
                        this.closeSidePanel();
                        await this.loadTemplates();
                    } else {
                        this.showNotification(result.error || 'Failed to delete template', 'error');
                    }
                } catch (error) {
                    console.error('Error deleting template:', error);
                    this.showNotification('Error deleting template', 'error');
                } finally {
                    this.showLoading(false);
                }
            }
            
            // ============ EMPLOYEE SELECTION ============
            
            async showEmployeeSelection(assignment) {
                const modal = document.getElementById('template-modal');
                const modalTitle = document.getElementById('modal-title');
                const modalBody = document.getElementById('modal-body');
                
                modalTitle.textContent = 'Select Employees';
                
                try {
                    const response = await fetch(`/api/v2/employees?cabang_id=${assignment.cabang_id || ''}`);
                    const employees = await response.json();
                    
                    modalBody.innerHTML = `
                        <div id="employee-list">
                            ${employees.map(emp => `
                                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                    <input type="checkbox" value="${emp.id}" class="employee-checkbox" style="margin-right: 10px;">
                                    <span>${emp.nama_lengkap}</span>
                                    <span style="color: #666; margin-left: auto; font-size: 12px;">${emp.posisi}</span>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-success" onclick="app.assignToSelected()" style="flex: 1;">
                                Assign to Selected
                            </button>
                            <button class="btn btn-secondary" onclick="app.closeModal()">Cancel</button>
                        </div>
                    `;
                    
                    modal.classList.add('active');
                    
                } catch (error) {
                    console.error('Error loading employees:', error);
                    this.showNotification('Error loading employees', 'error');
                }
            }
            
            async assignToSelected() {
                const selectedEmployees = Array.from(document.querySelectorAll('.employee-checkbox:checked'))
                    .map(cb => cb.value);
                
                if (selectedEmployees.length === 0) {
                    this.showNotification('Please select at least one employee', 'warning');
                    return;
                }
                
                // Here you would make the actual assignment
                this.closeModal();
                this.showNotification(`Assigned to ${selectedEmployees.length} employees`, 'success');
            }
            
            // ============ REAL-TIME CONNECTIVITY ============
            
            connectWebSocket() {
                // WebSocket connection for real-time updates
                // This would connect to your WebSocket server
                try {
                    // this.websocket = new WebSocket('ws://localhost:8080/calendar');
                    
                    // For now, simulate connection
                    setTimeout(() => {
                        this.isConnected = true;
                        this.updateConnectionStatus();
                    }, 1000);
                    
                } catch (error) {
                    console.error('WebSocket connection failed:', error);
                }
            }
            
            updateConnectionStatus() {
                const statusElement = document.getElementById('connection-status');
                const syncTimeElement = document.getElementById('sync-time');
                
                if (this.isConnected) {
                    statusElement.innerHTML = '<span style="color: #4caf50;">‚óè</span> Connected';
                    syncTimeElement.textContent = 'Just now';
                } else {
                    statusElement.innerHTML = '<span style="color: #f44336;">‚óè</span> Disconnected';
                }
            }
            
            // ============ UI HELPERS ============
            
            setupEventListeners() {
                // Navigation
                document.getElementById('prev-month')?.addEventListener('click', () => {
                    this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                    this.generateCalendar();
                });
                
                document.getElementById('next-month')?.addEventListener('click', () => {
                    this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                    this.generateCalendar();
                });
                
                // View switching
                document.getElementById('view-month')?.addEventListener('click', () => {
                    this.currentView = 'month';
                    this.updateViewButtons();
                    this.generateCalendar();
                });
                
                document.getElementById('view-week')?.addEventListener('click', () => {
                    this.currentView = 'week';
                    this.updateViewButtons();
                    this.generateCalendar();
                });
                
                document.getElementById('view-day')?.addEventListener('click', () => {
                    this.currentView = 'day';
                    this.updateViewButtons();
                    this.generateCalendar();
                });
                
                // Template management
                document.getElementById('add-template')?.addEventListener('click', () => {
                    this.createTemplate();
                });
                
                document.getElementById('new-template')?.addEventListener('click', () => {
                    this.createTemplate();
                });
                
                // Side panel
                document.getElementById('close-panel')?.addEventListener('click', () => {
                    this.closeSidePanel();
                });
                
                // Modal
                document.getElementById('close-modal')?.addEventListener('click', () => {
                    this.closeModal();
                });
                
                // Search
                document.getElementById('search-input')?.addEventListener('input', (e) => {
                    this.filterTemplates(e.target.value);
                });
                
                // Import/Export
                document.getElementById('import-templates')?.addEventListener('click', () => {
                    this.importTemplates();
                });
                
                document.getElementById('export-templates')?.addEventListener('click', () => {
                    this.exportTemplates();
                });
            }
            
            updateViewButtons() {
                const buttons = ['view-month', 'view-week', 'view-day'];
                buttons.forEach(btnId => {
                    const btn = document.getElementById(btnId);
                    if (btn) {
                        if (btnId === `view-${this.currentView}`) {
                            btn.classList.add('btn-primary');
                            btn.classList.remove('btn-secondary');
                        } else {
                            btn.classList.remove('btn-primary');
                            btn.classList.add('btn-secondary');
                        }
                    }
                });
            }
            
            updateMonthLabel() {
                const monthNames = [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ];
                
                const label = document.querySelector('.month-label');
                if (label) {
                    label.textContent = `${monthNames[this.currentDate.getMonth()]} ${this.currentDate.getFullYear()}`;
                }
            }
            
            formatTime(timeString) {
                return timeString ? timeString.slice(0, 5) : '';
            }
            
            closeSidePanel() {
                const panel = document.getElementById('template-side-panel');
                panel.classList.remove('open');
            }
            
            closeModal() {
                const modal = document.getElementById('template-modal');
                modal.classList.remove('active');
            }
            
            showLoading(show) {
                const spinner = document.getElementById('loading-spinner');
                if (spinner) {
                    spinner.style.display = show ? 'block' : 'none';
                }
            }
            
            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.classList.add('show');
                }, 100);
                
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            }
            
            filterTemplates(searchTerm) {
                const cards = document.querySelectorAll('.template-card');
                const term = searchTerm.toLowerCase();
                
                cards.forEach(card => {
                    const name = card.querySelector('.template-name')?.textContent.toLowerCase() || '';
                    const category = card.querySelector('.template-time')?.textContent.toLowerCase() || '';
                    
                    if (name.includes(term) || category.includes(term)) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            }
            
            async importTemplates() {
                // File input for import
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json,.csv,.xml';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        // Handle file import
                        this.showNotification('Import functionality coming soon', 'info');
                    }
                };
                input.click();
            }
            
            async exportTemplates() {
                try {
                    const response = await fetch('/api/v3/import-export?format=json');
                    const result = await response.json();
                    
                    if (result.success) {
                        // Trigger download
                        const blob = new Blob([JSON.stringify(result.data, null, 2)], {
                            type: 'application/json'
                        });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `calendar_templates_${new Date().toISOString().split('T')[0]}.json`;
                        a.click();
                        URL.revokeObjectURL(url);
                    }
                } catch (error) {
                    console.error('Error exporting templates:', error);
                    this.showNotification('Error exporting templates', 'error');
                }
            }
            
            updateUI() {
                this.updateConnectionStatus();
                this.updateViewButtons();
                
                // Update user info
                const userElement = document.getElementById('current-user');
                if (userElement && window.currentUser) {
                    userElement.textContent = window.currentUser.nama_lengkap;
                }
            }
        }
        
        // ============ INITIALIZE APPLICATION ============
        
        const app = new AdvancedCalendarApp();
        
        // Make app globally accessible for event handlers
        window.app = app;
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Advanced Calendar App initialized');
        });
    </script>
</body>
</html>